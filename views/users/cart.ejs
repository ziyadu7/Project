<%- include('../layouts/commonHeader.ejs') %>

<section class="shop-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="shop__cart__table">
                    <table id="cartTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Image</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <%if(cartProducts==undefined){%>
                                <%}else{%>
                                    <%if(cartProducts.item){%>
                                        <%cartProducts.item.forEach((item)=>{%>
                                            <%if(item.product.is_show===true){%>
                                                <tr>
                                                    <td class="cart__product__item">
                                                        <div class="cart__product__item__title">
                                                            <h6><%=item.product.title%></h6>
                                                        </div>
                                                    </td>
                                                    <td class="cart__product__item">
                                                        <div class="cart__product__item__title">
                                                            <img width="40px" height="50px" src="/proImage/<%=item.product.image[0]%>" alt="">
                                                        </div>
                                                    </td>
                                                    <td class="cart__price">₹ <%=item.price%></td>
                                                    <td class="cart__quantity">
                                                  <div class="pro-qty d-flex align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <button class="quantity__minus" data-id="<%=item._id%>" data-index="">-</button>
                                                        <h5 id="quantity-" class="ml-3 mr-3"><%=item.quantity%></h5>
                                                        <button class="quantity__plus" data-id="<%=item._id%>" data-index="">+</button>
                                                    </div>
                                                    </td>
                                                    <td class="cart__total" id="productTotal<%=item._id%>">₹ <%=item.price*item.quantity%></td>
                                                    <td class="cart__close"><a href="/removeCart?id=<%=item._id%>"><span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></svg></span></a></td>
                                                </tr>
                                                <%}%>
                              
                                   <%})%>
                           <%}%>
                           <%}%>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class=" d-flex justify-content-end">
                <div class="col-lg-6 col-md-6 col-sm-6">
                <div class="cart__btn update__btn">
                    <a href="/shopPage"><span class="icon_loading"></span> Continue shoping</a>
                </div>
            </div>
            </div>
        </div>
        <div class="row">
            <div class=" d-flex justify-content-end">
                <div class="col-lg-4 offset-lg-2">
                <div class="cart__total__procced">
                    <h6>Cart total</h6>
                    <ul>
                        <%if(totalPrice){%>
                            <li>Total <span id="TotalPrice">₹ <%=totalPrice%></span></li> 
                        <%}%>
                    </ul>
                    <a href="/checkOut" class="primary-btn">Proceed to checkout</a>
                </div>
            </div>
            </div>
        </div>
    </div>
</section>

<%if(msg){%>
    <script>
      new Swal({
          title: "Error",
          text: "<%=msg%>",
          icon: "error",
          showConfirmButton:false,
          timer:2000
        });
    </script>
<%}%>

<script>


// const plusBtns = document.querySelectorAll('.quantity__plus')
// plusBtns.forEach(btn => {
//     btn.addEventListener('click', function(event) {
//         event.preventDefault();
//         console.log('Button clicked');
//         const proid = event.target.dataset.id;
//         const userId = '<%=session%>';
//         fetch(`/incrementCart?id=${proid}&userId=${userId}`)
//         .then(res => window.location.reload())
//         .catch(err => console.log(err))
//     })
// })


const plusBtns = document.querySelectorAll('.quantity__plus');
plusBtns.forEach(btn => {
    btn.addEventListener('click', function(event) {
        event.preventDefault();
        console.log('Button clicked');
        const proid = event.target.dataset.id;
        const userId = '<%=session%>';
        fetch(`/incrementCart?id=${proid}&userId=${userId}`)
        .then(res => res.json())
        .then(data => {
            // Update the quantity displayed on the page
            
            const quantityEl = event.target.parentElement.querySelector('#quantity-');
            quantityEl.innerText = data.quantity;
           document.querySelector(`#productTotal${proid}`).textContent ='₹'+ data.price
           document.querySelector('#TotalPrice').innerText ='₹'+ data.totalPrice
        })
        .catch(err => console.log(err))
    });
});


const minusBtns = document.querySelectorAll('.quantity__minus');
minusBtns.forEach(btn => {
    btn.addEventListener('click', function(event) {
        event.preventDefault();
        console.log('Button clicked');
        const proid = event.target.dataset.id;
        const userId = '<%=session%>';
        fetch(`/decrementcart?id=${proid}&userId=${userId}`)
        .then(res => res.json())
        .then(data => {
            // Update the quantity displayed on the page
            
            const quantityEl = event.target.parentElement.querySelector('#quantity-');
            quantityEl.innerText = data.quantity;
           document.querySelector(`#productTotal${proid}`).textContent ='₹'+ data.price
           document.querySelector('#TotalPrice').innerText ='₹'+ data.totalPrice
        })
        .catch(err => console.log(err))
    });
});

// const minusBtns = document.querySelectorAll('.quantity__minus')
// minusBtns.forEach(btn => {
//     btn.addEventListener('click', (event) => {
//         const proid = event.target.dataset.id
//         const userId = '<%=session%>'
//         fetch(`/decrementCart?id=${proid}&userId=${userId}`)
//         .then(res =>{window.location.reload()})
//         .catch(err => console.log(err))
//     })
// })
</script>
<%- include('../layouts/pagesFooter.ejs') %>