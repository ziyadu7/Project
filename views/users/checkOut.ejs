<%- include('../layouts/commonHeader.ejs') %>

    <%if(addressCount){ %>
        <section class="checkout spad">
            <div class="container">
                <div class="row">
                </div>
                <form action="/placeOrder" class="checkout__form">
                    <div class="row">
                        <div class="col-lg-8">
                            <h5>Billing detail</h5>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="checkout__form__input">
                                        <p>Name <span>*</span></p>
                                        <input type="text" value="<%=user.username%>" name="name" disabled>
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="checkout__form__input">
                                        <p>Country <span>*</span></p>
                                        <input type="text" value="<%=addressCount.country%>" name="country" disabled>
                                    </div>
                                    <div class="checkout__form__input">
                                        <p>Address <span>*</span></p>
                                        <input type="text" value="<%=addressCount.address%>" name="address" disabled>

                                    </div>
                                    <div class="checkout__form__input">
                                        <p>Town/City <span>*</span></p>
                                        <input type="text" value="<%=addressCount.city%>" name="city" disabled>
                                    </div>
                                    <div class="checkout__form__input">
                                        <p>State <span>*</span></p>
                                        <input type="text" value="<%=addressCount.district%>" disabled>
                                    </div>
                                    <div class="checkout__form__input">
                                        <p>State <span>*</span></p>
                                        <input type="text" value="<%=addressCount.state%>" disabled>
                                    </div>

                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="checkout__form__input">
                                        <p>Phone <span>*</span></p>
                                        <input type="tel" value="<%=user.phone%>" name="phone" disabled>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="checkout__form__input">
                                        <p>Email <span>*</span></p>
                                        <input type="emal" value="<%=user.email%>" name="email" disabled>
                                    </div>
                                </div>
                            </div>
                            <a href="/selectAddress" class="btn btn-primary">Select address</a>
                        </div>

                        <%if(cart.item!=null){%>
                            <div class="col-lg-4">
                                <div class="checkout__order">
                                    <h5>Your order</h5>
                                    <div class="checkout__order__product">
                                        <ul>
                                            <li>
                                                <span class="top__text">Product</span>
                                                <span class="top__text__right">Total</span>
                                            </li>
                                            <%cart.item.forEach((item)=>{%>
                                                <li>
                                                    <%=item.product.title%><span>Rs <%=item.quantity*item.price%></span>
                                                </li>
                                                <%})%>
                                        </ul>
                                    </div>
                                    <div class="checkout__order__total">
                                        <ul>
                                            <li>Subtotal <span>Rs <%=cart.totalPrice%></span></li>
                                            <%if(cart.couponDiscount){%>
                                                <li>
                                                    <a id="dicount"
                                                        style="text-decoration: none; pointer-events: none;">Coupon
                                                        Discount</a>
    
                                                    <span id="disc" name="disc" class="text-success">Rs <%=cart.couponDiscount%></span>
                                                </li>
                                                <li>Total <span>Rs <%=parseInt(cart.totalPrice)-cart.couponDiscount%></span></li>
                                            <%}else{%>
                                                <li>
                                                    <a id="dicount"
                                                        style="text-decoration: none; pointer-events: none;">Coupon
                                                        Discount</a>
    
                                                    <span id="disc" name="disc" class="text-success">0</span>
                                                </li>
                                                <li>Total <span class="totalPrice">Rs <%=cart.totalPrice%></span></li>
                                            <%}%>
                                            
                                        </ul>
                                    </div>
                                    <button type="submit" class="site-btn">Place oder</button>
                                </div>
                            </div>
                            <%}else{%>

                                <%}%>
                    </div>
                </form>

                <div class="cupon_area">

                    <h2 class="mb-2">Enter coupon details</h2>
                    <form id="coupon-form-submit">


                        <input type="text" placeholder="Enter coupon code" id="coupon" name="coupon">


                        <button class="btn_3 ms-4" type="submit" form="coupon-form-submit" id="applyCoupon"> Apply
                            Coupon</button>
                        <small id="codestate"></small>





                    </form>



                </div>
            </div>
        </section>
        <%}else if(user.address[0]){%>

            <section class="checkout spad">
                <div class="container">
                    <div class="row">
                    </div>
                    <form action="/placeOrder" class="checkout__form">
                        <div class="row">
                            <div class="col-lg-8">
                                <h5>Billing detail</h5>
                                <div class="row">
                                    <div class="col-lg-6 col-md-6 col-sm-6">
                                        <div class="checkout__form__input">
                                            <p>Name <span>*</span></p>
                                            <input type="text" value="<%=user.username%>" name="name" disabled>
                                        </div>
                                    </div>

                                    <div class="col-lg-12">
                                        <div class="checkout__form__input">
                                            <p>Country <span>*</span></p>
                                            <input type="text" value="<%=user.address[0].country%>" name="country"
                                                disabled>
                                        </div>
                                        <div class="checkout__form__input">
                                            <p>Address <span>*</span></p>
                                            <input type="text" value="<%=user.address[0].address%>" name="address"
                                                disabled>

                                        </div>
                                        <div class="checkout__form__input">
                                            <p>Town/City <span>*</span></p>
                                            <input type="text" value="<%=user.address[0].city%>" name="city" disabled>
                                        </div>
                                        <div class="checkout__form__input">
                                            <p>State <span>*</span></p>
                                            <input type="text" value="<%=user.address[0].district%>" disabled>
                                        </div>
                                        <div class="checkout__form__input">
                                            <p>State <span>*</span></p>
                                            <input type="text" value="<%=user.address[0].state%>" disabled>
                                        </div>

                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6">
                                        <div class="checkout__form__input">
                                            <p>Phone <span>*</span></p>
                                            <input type="tel" value="<%=user.phone%>" name="phone" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6">
                                        <div class="checkout__form__input">
                                            <p>Email <span>*</span></p>
                                            <input type="emal" value="<%=user.email%>" name="email" disabled>
                                        </div>
                                    </div>
                                </div>
                                <a href="/selectAddress" class="btn btn-primary">Select address</a>
                            </div>
                            <div class="col-lg-4">
                                <div class="checkout__order">
                                    <h5>Your order</h5>
                                    <div class="checkout__order__product">
                                        <ul>
                                            <li>
                                                <span class="top__text">Product</span>
                                                <span class="top__text__right">Total</span>
                                            </li>
                                            <%cart.item.forEach((item)=>{%>
                                                <li>
                                                    <%=item.product.title%><span>Rs <%=item.quantity*item.price%></span>
                                                </li>
                                                <%})%>
                                        </ul>
                                    </div>
                                    <div class="checkout__order__total">
                                        <ul>
                                            <li>Subtotal <span>Rs <%=cart.totalPrice%></span></li>
                                            <%if(cart.couponDiscount){%>
                                                <li>
                                                    <a id="dicount"
                                                        style="text-decoration: none; pointer-events: none;">Coupon
                                                        Discount</a>
    
                                                    <span id="disc" name="disc" class="text-success">Rs <%=cart.couponDiscount%></span>
                                                </li>
                                                <li>Total <span>Rs <%=parseInt(cart.totalPrice)-cart.couponDiscount%></span></li>
                                            <%}else{%>
                                                <li>
                                                    <a id="dicount"
                                                        style="text-decoration: none; pointer-events: none;">Coupon
                                                        Discount</a>
    
                                                    <span id="disc" name="disc" class="text-success">0</span>
                                                </li>
                                                <li>Total <span class="totalPrice">Rs <%=cart.totalPrice%></span></li>
                                            <%}%>
                                            
                                        </ul>
                                    </div>
                                    <button type="submit" class="site-btn">Place oder</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="cupon_area">

                        <h2 class="mb-2">Enter coupon details</h2>
                        <form id="coupon-form-submit">


                            <input type="text" placeholder="Enter coupon code" id="coupon" name="coupon">


                            <button class="btn_3 ms-4" type="submit" form="coupon-form-submit" id="applyCoupon"> Apply
                                Coupon</button>
                            <small id="codestate"></small>





                        </form>



                    </div>
                </div>
            </section>


            <%}else{%>

                <section class="checkout spad">
                    <div class="container">
                        <div class="row">
                        </div>
                        <form action="/addAddress" method="post" class="checkout__form" method="post">
                            <div class="row">
                                <div class="col-lg-8">
                                    <h5>Enter Address</h5>
                                    <div class="row">

                                        <div class="col-lg-12">
                                            <div class="checkout__form__input">
                                                <p>Country <span>*</span></p>
                                                <input type="text" name="country">
                                            </div>
                                            <div class="checkout__form__input">
                                                <p>Address <span>*</span></p>
                                                <input type="text" name="address">

                                            </div>
                                            <div class="checkout__form__input">
                                                <p>Town/City <span>*</span></p>
                                                <input type="text" name="city">
                                            </div>
                                            <div class="checkout__form__input">
                                                <p>District <span>*</span></p>
                                                <input type="text" name="district">
                                            </div>
                                            <div class="checkout__form__input">
                                                <p>State <span>*</span></p>
                                                <input type="text" name="state">
                                            </div>

                                        </div>

                                    </div>
                                    <div>
                                        <button class="btn btn-danger" type="submit">ADD ADDRESS</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>

                <%}%>


                    <script>

                        $("#coupon-form-submit").submit((e) => {
                            let couponValue = document.getElementById('coupon').value;
                            e.preventDefault();
                            $.ajax({
                                url: '/checkCoupon',
                                method: 'post',
                                data: { coupon: couponValue },
                                success: (response) => {
                                    if (response.status) {
                                        console.log(response.discountPrice)
                                        $("#total").load(location.href + " #total");
                                        $("#discount1").val(response.discountPrice);
                                        $("#coupon1").val(couponValue);
                                        document.getElementById('disc').innerText = 'Rs' + response.discountPrice
                                        console.log(response.amount);
                                        document.getElementById('ok').innerText = 'Rs' + response.amount
                                        document.getElementsByClassName('totalPrice').innerText ='Rs' + response.amount;
                                        document.getElementById('codestate').style.color = "green"
                                        document.getElementById('codestate').innerText = 'Coupon applied successfully'
                                        $("#cancelBtn").show();
                                        $("#applyCoupon").hide();
                                    } else if (response.used) {
                                        document.getElementById('codestate').style.color = "red"
                                        document.getElementById('codestate').innerText = 'Coupon already used!'
                                    } else if (response.expired) {
                                        document.getElementById('codestate').style.color = "red"
                                        document.getElementById('codestate').innerText = 'Sorry coupon is expired!'
                                    } else if (response.noMatch) {
                                        document.getElementById('codestate').style.color = "red"
                                        document.getElementById('codestate').innerText = 'Oops invalid coupon code!'
                                    } else if(response.lessPrice){
                                        document.getElementById('codestate').style.color = "red"
                                        document.getElementById('codestate').innerText = 'Pleae purchase more!'
                                    }
                                }
                            })
                        })

                    </script>
                    <%- include('../layouts/pagesFooter.ejs') %>